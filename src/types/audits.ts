import { Timestamp } from 'firebase/firestore';

// ============================================
// ENUMS Y TIPOS
// ============================================

export type AuditType = 'complete' | 'partial';
export type AuditStatus = 'planned' | 'in_progress' | 'completed';

export type ConformityStatus =
  | 'CF' // Cumple satisfactoriamente
  | 'NCM' // No conformidad mayor
  | 'NCm' // No conformidad menor
  | 'NCT' // No conformidad trivial
  | 'R' // Riesgo
  | 'OM' // Oportunidad de mejora
  | 'F' // Fortaleza
  | null; // No verificado

// ============================================
// INTERFACES DE DATOS
// ============================================

export interface NormPointVerification {
  normPointCode: string;
  normPointId: string | null; // Preparar para futuro
  conformityStatus: ConformityStatus;
  processes: string[];
  processIds: string[] | null; // Preparar para futuro
  observations: string | null;
  verifiedAt: Timestamp | null;
  verifiedBy: string | null;
  verifiedByName: string | null;
}

export interface Participant {
  name: string;
  role: string;
  userId: string | null; // Preparar para futuro
}

export interface OpeningMeeting {
  date: Timestamp;
  participants: Participant[];
  notes: string | null;
}

export interface ClosingMeeting {
  date: Timestamp;
  participants: Participant[];
  notes: string | null;
}

export interface ReportDelivery {
  date: Timestamp;
  deliveredBy: string;
  deliveredById: string | null; // Preparar para futuro
  receivedBy: string[];
  receivedByIds: string[] | null; // Preparar para futuro
  notes: string | null;
}

// ============================================
// MODELO PRINCIPAL
// ============================================

export interface Audit {
  // Identificaci√≥n
  id: string;
  auditNumber: string;

  // Planificaci√≥n
  title: string;
  auditType: AuditType;
  scope: string;
  plannedDate: Timestamp;
  leadAuditor: string;
  leadAuditorId: string | null; // Preparar para futuro
  selectedNormPoints: string[]; // Solo para auditor√≠as parciales

  // Ejecuci√≥n
  executionDate: Timestamp | null;
  normPointsVerification: NormPointVerification[];
  openingMeeting: OpeningMeeting | null;
  closingMeeting: ClosingMeeting | null;
  reportDelivery: ReportDelivery | null;
  previousActionsVerification: string | null;
  observations: string | null;

  // Estado
  status: AuditStatus;

  // Metadatos
  createdAt: Timestamp;
  updatedAt: Timestamp;
  createdBy: string;
  createdByName: string;
  isActive: boolean;
}

// ============================================
// FORMULARIOS
// ============================================

export interface AuditFormData {
  title: string;
  auditType: AuditType;
  scope: string;
  plannedDate: Date;
  leadAuditor: string;
  selectedNormPoints: string[]; // Solo si auditType = 'partial'
}

export interface AuditExecutionStartData {
  executionDate: Date;
}

export interface NormPointVerificationFormData {
  normPointCode: string;
  conformityStatus: ConformityStatus;
  processes: string[];
  observations: string | null;
}

export interface MeetingFormData {
  date: Date;
  participants: Omit<Participant, 'userId'>[];
  notes: string | null;
}

export interface ReportDeliveryFormData {
  date: Date;
  deliveredBy: string;
  receivedBy: string[];
  notes: string | null;
}

// ============================================
// LABELS Y CONFIGURACI√ìN
// ============================================

export const AUDIT_TYPE_LABELS: Record<AuditType, string> = {
  complete: 'Auditor√≠a Completa',
  partial: 'Auditor√≠a Parcial',
};

export const AUDIT_STATUS_LABELS: Record<AuditStatus, string> = {
  planned: 'Planificada',
  in_progress: 'En Progreso',
  completed: 'Completada',
};

export const CONFORMITY_STATUS_LABELS: Record<string, string> = {
  CF: 'Cumple Satisfactoriamente',
  NCM: 'No Conformidad Mayor',
  NCm: 'No Conformidad Menor',
  NCT: 'No Conformidad Trivial',
  R: 'Riesgo',
  OM: 'Oportunidad de Mejora',
  F: 'Fortaleza',
};

export const CONFORMITY_STATUS_COLORS: Record<string, string> = {
  CF: 'bg-green-100 text-green-800 border-green-300',
  NCM: 'bg-red-100 text-red-800 border-red-300',
  NCm: 'bg-orange-100 text-orange-800 border-orange-300',
  NCT: 'bg-yellow-100 text-yellow-800 border-yellow-300',
  R: 'bg-purple-100 text-purple-800 border-purple-300',
  OM: 'bg-blue-100 text-blue-800 border-blue-300',
  F: 'bg-emerald-100 text-emerald-800 border-emerald-300',
};

export const AUDIT_STATUS_COLORS: Record<AuditStatus, string> = {
  planned: 'bg-gray-100 text-gray-800',
  in_progress: 'bg-blue-100 text-blue-800',
  completed: 'bg-green-100 text-green-800',
};

// ============================================
// HELPERS
// ============================================

export function getConformityStatusIcon(status: ConformityStatus): string {
  switch (status) {
    case 'CF':
      return '‚úÖ';
    case 'NCM':
      return '‚ùå';
    case 'NCm':
      return '‚ö†Ô∏è';
    case 'NCT':
      return '‚ö°';
    case 'R':
      return 'üîÆ';
    case 'OM':
      return 'üí°';
    case 'F':
      return 'üí™';
    default:
      return '‚óã';
  }
}

export function getAuditProgress(audit: Audit): number {
  if (audit.status === 'planned') return 0;
  if (audit.status === 'completed') return 100;

  const totalPoints = audit.normPointsVerification.length;
  if (totalPoints === 0) return 0;

  const verifiedPoints = audit.normPointsVerification.filter(
    v => v.conformityStatus !== null
  ).length;

  return Math.round((verifiedPoints / totalPoints) * 100);
}

export function getConformitySummary(audit: Audit): Record<string, number> {
  const summary: Record<string, number> = {
    CF: 0,
    NCM: 0,
    NCm: 0,
    NCT: 0,
    R: 0,
    OM: 0,
    F: 0,
    pending: 0,
  };

  audit.normPointsVerification.forEach(verification => {
    if (verification.conformityStatus === null) {
      summary.pending++;
    } else {
      summary[verification.conformityStatus]++;
    }
  });

  return summary;
}
